name: Draft Release

on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write

jobs:
  draft-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release notes
        id: release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Extract changelog for this version
          CHANGELOG=$(sed -n "/## v${VERSION}/,/## v/p" CHANGELOG.md 2>/dev/null || echo "No changelog entries found for v${VERSION}")
          
          # Remove the last "## v" section if it exists
          CHANGELOG=$(echo "$CHANGELOG" | sed '$d')
          
          # If no changelog found, use git log
          if [ -z "$CHANGELOG" ] || [ "$CHANGELOG" = "No changelog entries found for v${VERSION}" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$PREV_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" 2>/dev/null || echo "Initial release")
            else
              CHANGELOG=$(git log ${PREV_TAG}..${GITHUB_REF} --pretty=format:"- %s (%h)" 2>/dev/null)
            fi
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "CHANGELOG=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Currency Converter ${{ steps.release.outputs.VERSION }}
          body: |
            # Currency Converter v${{ steps.release.outputs.VERSION }}
            
            ## Changes
            ${{ steps.release.outputs.CHANGELOG }}
            
            ## Downloads
            - **Linux AppImage**: `currency-converter-v${{ steps.release.outputs.VERSION }}-x86_64.AppImage`
            - **Windows Installer**: Coming soon...
            
            ## Installation
            
            ### Linux
            ```bash
            chmod +x currency-converter-v${{ steps.release.outputs.VERSION }}-x86_64.AppImage
            ./currency-converter-v${{ steps.release.outputs.VERSION }}-x86_64.AppImage
            ```
            
            ### Windows
            Run the `.exe` or `.msi` installer directly.
            
            ---
            
            Built with ❤️ on Rust, Svelte and Tauri
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
