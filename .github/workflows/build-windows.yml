name: Build Windows

on:
  push:
    branches: [master, main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main, develop]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Windows)
        run: |
          # Visual Studio Build Tools should be pre-installed on windows-latest
          # We just need to ensure we have the necessary SDK components
          # Check MSVC is available
          where cl.exe

      - name: Cache Rust build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri'

      - name: Install Node dependencies
        run: npm install

      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Build Tauri app
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: src-tauri

      - name: Build Windows bundle
        run: npm run tauri:build
        env:
          RUSTFLAGS: -C target-feature=+crt-static

      - name: Locate exe
        id: locate
        shell: pwsh
        run: |
          $exe_path = Get-ChildItem -Path "src-tauri/target/release" -Name "currency-converter.exe" -ErrorAction SilentlyContinue
          if ($exe_path) {
            $full_path = "src-tauri/target/release/$exe_path"
            Write-Host "Found EXE: $full_path"
            "EXE_PATH=$full_path" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "ERROR: EXE not found!"
            Get-ChildItem "src-tauri/target/release" -Recurse -Include "*.exe" | Select-Object -First 20
            exit 1
          }

      - name: Locate MSI installer
        id: locate_msi
        shell: pwsh
        run: |
          $msi_path = Get-ChildItem -Path "src-tauri/target/release/bundle/msi" -Name "*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($msi_path) {
            $full_path = "src-tauri/target/release/bundle/msi/$msi_path"
            Write-Host "Found MSI: $full_path"
            "MSI_PATH=$full_path" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "MSI_NAME=$msi_path" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "WARNING: MSI not found, will try to locate any installer"
            Get-ChildItem "src-tauri/target/release/bundle" -Recurse -Include "*.msi", "*.exe" | Select-Object -First 20
          }

      - name: Get version from package.json
        id: version
        shell: pwsh
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          Write-Host "VERSION=$version"
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Rename and prepare artifacts
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          
          # Prepare EXE
          if (Test-Path "${{ steps.locate.outputs.EXE_PATH }}") {
            $exe_dir = Split-Path "${{ steps.locate.outputs.EXE_PATH }}" -Parent
            $new_exe_name = "currency-converter-v${version}-x86_64.exe"
            Copy-Item "${{ steps.locate.outputs.EXE_PATH }}" "$exe_dir/$new_exe_name"
            Write-Host "Prepared EXE: $new_exe_name"
          }
          
          # Prepare MSI if available
          if ("${{ steps.locate_msi.outputs.MSI_PATH }}" -ne "") {
            $msi_dir = Split-Path "${{ steps.locate_msi.outputs.MSI_PATH }}" -Parent
            $new_msi_name = "currency-converter-v${version}-x86_64.msi"
            Copy-Item "${{ steps.locate_msi.outputs.MSI_PATH }}" "$msi_dir/$new_msi_name"
            Write-Host "Prepared MSI: $new_msi_name"
          }

      - name: Upload EXE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: currency-converter-windows-x86_64-exe
          path: src-tauri/target/release/currency-converter-v*.exe
          if-no-files-found: warn
          retention-days: 30

      - name: Upload MSI as artifact
        uses: actions/upload-artifact@v4
        with:
          name: currency-converter-windows-x86_64-msi
          path: src-tauri/target/release/bundle/msi/currency-converter-v*.msi
          if-no-files-found: warn
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/currency-converter-v*.exe
            src-tauri/target/release/bundle/msi/currency-converter-v*.msi
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print build summary
        shell: pwsh
        run: |
          Write-Host "âœ… Build completed successfully!"
          Write-Host "Platform: Windows x86_64"
          Write-Host "Version: v${{ steps.version.outputs.VERSION }}"
          Write-Host ""
          Write-Host "ðŸ“¦ Artifacts:"
          if (Test-Path "src-tauri/target/release/currency-converter-v*.exe") {
            Get-ChildItem "src-tauri/target/release/currency-converter-v*.exe" | ForEach-Object { Write-Host "  - $($_.Name) ($([Math]::Round($_.Length/1MB, 2)) MB)" }
          }
          if (Test-Path "src-tauri/target/release/bundle/msi/currency-converter-v*.msi") {
            Get-ChildItem "src-tauri/target/release/bundle/msi/currency-converter-v*.msi" | ForEach-Object { Write-Host "  - $($_.Name) ($([Math]::Round($_.Length/1MB, 2)) MB)" }
          }
